{"ast":null,"code":"\"use strict\";\n\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    if (typeof b !== \"function\" && b !== null) throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.collectMethods = exports.LooksAhead = void 0;\n\nvar lookahead_1 = require(\"../../grammar/lookahead\");\n\nvar forEach_1 = __importDefault(require(\"lodash/forEach\"));\n\nvar has_1 = __importDefault(require(\"lodash/has\"));\n\nvar parser_1 = require(\"../parser\");\n\nvar keys_1 = require(\"../../grammar/keys\");\n\nvar gast_1 = require(\"@chevrotain/gast\");\n\nvar gast_2 = require(\"@chevrotain/gast\");\n/**\n * Trait responsible for the lookahead related utilities and optimizations.\n */\n\n\nvar LooksAhead =\n/** @class */\nfunction () {\n  function LooksAhead() {}\n\n  LooksAhead.prototype.initLooksAhead = function (config) {\n    this.dynamicTokensEnabled = (0, has_1.default)(config, \"dynamicTokensEnabled\") ? config.dynamicTokensEnabled // assumes end user provides the correct config value/type\n    : parser_1.DEFAULT_PARSER_CONFIG.dynamicTokensEnabled;\n    this.maxLookahead = (0, has_1.default)(config, \"maxLookahead\") ? config.maxLookahead // assumes end user provides the correct config value/type\n    : parser_1.DEFAULT_PARSER_CONFIG.maxLookahead;\n    this.lookAheadFuncsCache = new Map();\n  };\n\n  LooksAhead.prototype.preComputeLookaheadFunctions = function (rules) {\n    var _this = this;\n\n    (0, forEach_1.default)(rules, function (currRule) {\n      _this.TRACE_INIT(\"\".concat(currRule.name, \" Rule Lookahead\"), function () {\n        var _a = collectMethods(currRule),\n            alternation = _a.alternation,\n            repetition = _a.repetition,\n            option = _a.option,\n            repetitionMandatory = _a.repetitionMandatory,\n            repetitionMandatoryWithSeparator = _a.repetitionMandatoryWithSeparator,\n            repetitionWithSeparator = _a.repetitionWithSeparator;\n\n        (0, forEach_1.default)(alternation, function (currProd) {\n          var prodIdx = currProd.idx === 0 ? \"\" : currProd.idx;\n\n          _this.TRACE_INIT(\"\".concat((0, gast_2.getProductionDslName)(currProd)).concat(prodIdx), function () {\n            var laFunc = (0, lookahead_1.buildLookaheadFuncForOr)(currProd.idx, currRule, currProd.maxLookahead || _this.maxLookahead, currProd.hasPredicates, _this.dynamicTokensEnabled, _this.lookAheadBuilderForAlternatives);\n            var key = (0, keys_1.getKeyForAutomaticLookahead)(_this.fullRuleNameToShort[currRule.name], keys_1.OR_IDX, currProd.idx);\n\n            _this.setLaFuncCache(key, laFunc);\n          });\n        });\n        (0, forEach_1.default)(repetition, function (currProd) {\n          _this.computeLookaheadFunc(currRule, currProd.idx, keys_1.MANY_IDX, lookahead_1.PROD_TYPE.REPETITION, currProd.maxLookahead, (0, gast_2.getProductionDslName)(currProd));\n        });\n        (0, forEach_1.default)(option, function (currProd) {\n          _this.computeLookaheadFunc(currRule, currProd.idx, keys_1.OPTION_IDX, lookahead_1.PROD_TYPE.OPTION, currProd.maxLookahead, (0, gast_2.getProductionDslName)(currProd));\n        });\n        (0, forEach_1.default)(repetitionMandatory, function (currProd) {\n          _this.computeLookaheadFunc(currRule, currProd.idx, keys_1.AT_LEAST_ONE_IDX, lookahead_1.PROD_TYPE.REPETITION_MANDATORY, currProd.maxLookahead, (0, gast_2.getProductionDslName)(currProd));\n        });\n        (0, forEach_1.default)(repetitionMandatoryWithSeparator, function (currProd) {\n          _this.computeLookaheadFunc(currRule, currProd.idx, keys_1.AT_LEAST_ONE_SEP_IDX, lookahead_1.PROD_TYPE.REPETITION_MANDATORY_WITH_SEPARATOR, currProd.maxLookahead, (0, gast_2.getProductionDslName)(currProd));\n        });\n        (0, forEach_1.default)(repetitionWithSeparator, function (currProd) {\n          _this.computeLookaheadFunc(currRule, currProd.idx, keys_1.MANY_SEP_IDX, lookahead_1.PROD_TYPE.REPETITION_WITH_SEPARATOR, currProd.maxLookahead, (0, gast_2.getProductionDslName)(currProd));\n        });\n      });\n    });\n  };\n\n  LooksAhead.prototype.computeLookaheadFunc = function (rule, prodOccurrence, prodKey, prodType, prodMaxLookahead, dslMethodName) {\n    var _this = this;\n\n    this.TRACE_INIT(\"\".concat(dslMethodName).concat(prodOccurrence === 0 ? \"\" : prodOccurrence), function () {\n      var laFunc = (0, lookahead_1.buildLookaheadFuncForOptionalProd)(prodOccurrence, rule, prodMaxLookahead || _this.maxLookahead, _this.dynamicTokensEnabled, prodType, _this.lookAheadBuilderForOptional);\n      var key = (0, keys_1.getKeyForAutomaticLookahead)(_this.fullRuleNameToShort[rule.name], prodKey, prodOccurrence);\n\n      _this.setLaFuncCache(key, laFunc);\n    });\n  };\n\n  LooksAhead.prototype.lookAheadBuilderForOptional = function (alt, tokenMatcher, dynamicTokensEnabled) {\n    return (0, lookahead_1.buildSingleAlternativeLookaheadFunction)(alt, tokenMatcher, dynamicTokensEnabled);\n  };\n\n  LooksAhead.prototype.lookAheadBuilderForAlternatives = function (alts, hasPredicates, tokenMatcher, dynamicTokensEnabled) {\n    return (0, lookahead_1.buildAlternativesLookAheadFunc)(alts, hasPredicates, tokenMatcher, dynamicTokensEnabled);\n  }; // this actually returns a number, but it is always used as a string (object prop key)\n\n\n  LooksAhead.prototype.getKeyForAutomaticLookahead = function (dslMethodIdx, occurrence) {\n    var currRuleShortName = this.getLastExplicitRuleShortName();\n    return (0, keys_1.getKeyForAutomaticLookahead)(currRuleShortName, dslMethodIdx, occurrence);\n  };\n\n  LooksAhead.prototype.getLaFuncFromCache = function (key) {\n    return this.lookAheadFuncsCache.get(key);\n  };\n  /* istanbul ignore next */\n\n\n  LooksAhead.prototype.setLaFuncCache = function (key, value) {\n    this.lookAheadFuncsCache.set(key, value);\n  };\n\n  return LooksAhead;\n}();\n\nexports.LooksAhead = LooksAhead;\n\nvar DslMethodsCollectorVisitor =\n/** @class */\nfunction (_super) {\n  __extends(DslMethodsCollectorVisitor, _super);\n\n  function DslMethodsCollectorVisitor() {\n    var _this = _super !== null && _super.apply(this, arguments) || this;\n\n    _this.dslMethods = {\n      option: [],\n      alternation: [],\n      repetition: [],\n      repetitionWithSeparator: [],\n      repetitionMandatory: [],\n      repetitionMandatoryWithSeparator: []\n    };\n    return _this;\n  }\n\n  DslMethodsCollectorVisitor.prototype.reset = function () {\n    this.dslMethods = {\n      option: [],\n      alternation: [],\n      repetition: [],\n      repetitionWithSeparator: [],\n      repetitionMandatory: [],\n      repetitionMandatoryWithSeparator: []\n    };\n  };\n\n  DslMethodsCollectorVisitor.prototype.visitOption = function (option) {\n    this.dslMethods.option.push(option);\n  };\n\n  DslMethodsCollectorVisitor.prototype.visitRepetitionWithSeparator = function (manySep) {\n    this.dslMethods.repetitionWithSeparator.push(manySep);\n  };\n\n  DslMethodsCollectorVisitor.prototype.visitRepetitionMandatory = function (atLeastOne) {\n    this.dslMethods.repetitionMandatory.push(atLeastOne);\n  };\n\n  DslMethodsCollectorVisitor.prototype.visitRepetitionMandatoryWithSeparator = function (atLeastOneSep) {\n    this.dslMethods.repetitionMandatoryWithSeparator.push(atLeastOneSep);\n  };\n\n  DslMethodsCollectorVisitor.prototype.visitRepetition = function (many) {\n    this.dslMethods.repetition.push(many);\n  };\n\n  DslMethodsCollectorVisitor.prototype.visitAlternation = function (or) {\n    this.dslMethods.alternation.push(or);\n  };\n\n  return DslMethodsCollectorVisitor;\n}(gast_1.GAstVisitor);\n\nvar collectorVisitor = new DslMethodsCollectorVisitor();\n\nfunction collectMethods(rule) {\n  collectorVisitor.reset();\n  rule.accept(collectorVisitor);\n  var dslMethods = collectorVisitor.dslMethods; // avoid uncleaned references\n\n  collectorVisitor.reset();\n  return dslMethods;\n}\n\nexports.collectMethods = collectMethods;","map":{"version":3,"mappings":"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","names":["LooksAhead","config","dynamicTokensEnabled","parser_1","maxLookahead","lookAheadFuncsCache","Map","rules","currRule","_this","TRACE_INIT","name","collectMethods","alternation","repetition","option","repetitionMandatory","repetitionMandatoryWithSeparator","repetitionWithSeparator","currProd","prodIdx","idx","concat","laFunc","hasPredicates","lookAheadBuilderForAlternatives","key","fullRuleNameToShort","keys_1","setLaFuncCache","computeLookaheadFunc","lookahead_1","REPETITION","OPTION","REPETITION_MANDATORY","REPETITION_MANDATORY_WITH_SEPARATOR","REPETITION_WITH_SEPARATOR","rule","prodOccurrence","prodKey","prodType","prodMaxLookahead","dslMethodName","lookAheadBuilderForOptional","alt","tokenMatcher","alts","dslMethodIdx","occurrence","currRuleShortName","getLastExplicitRuleShortName","get","value","set","exports","__extends","DslMethodsCollectorVisitor","dslMethods","push","manySep","atLeastOne","atLeastOneSep","many","or","gast_1","collectorVisitor","reset","accept"],"sourceRoot":"","sources":["../../../../../src/parse/parser/traits/looksahead.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}