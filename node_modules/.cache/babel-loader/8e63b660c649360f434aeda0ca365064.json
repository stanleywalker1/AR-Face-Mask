{"ast":null,"code":"\"use strict\";\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.CameraSource = void 0;\n\nconst html_element_source_1 = require(\"./html-element-source\");\n\nconst profile_1 = require(\"./profile\");\n\nconst pipeline_1 = require(\"./pipeline\");\n\nconst cameramodel_1 = require(\"./cameramodel\");\n\nconst loglevel_1 = require(\"./loglevel\");\n\nlet latest = 1;\nlet byId = new Map();\n\nlet _videoSingleton = document.createElement(\"video\");\n\n_videoSingleton.setAttribute('playsinline', '');\n\n_videoSingleton.setAttribute('webkit-playsinline', '');\n\nif (profile_1.profile.videoElementInDOM) {\n  _videoSingleton.style.width = \"0px\";\n  _videoSingleton.style.height = \"0px\";\n  document.body.appendChild(_videoSingleton);\n}\n\nclass CameraSource extends html_element_source_1.HTMLElementSource {\n  constructor(_impl, pipeline, _deviceId) {\n    super(_videoSingleton, pipeline);\n    this._impl = _impl;\n    this._deviceId = _deviceId;\n    this._currentStream = null;\n    this._activeDeviceId = null;\n    this._hasStartedOrientation = false;\n\n    this._deviceMotionListener = ev => {\n      let pipeline = pipeline_1.Pipeline.get(this._pipeline);\n      if (!pipeline) return;\n      let timeStamp = ev.timeStamp !== undefined && ev.timeStamp !== null ? ev.timeStamp : performance.now();\n\n      if (ev.accelerationIncludingGravity !== null && ev.accelerationIncludingGravity.x !== null && ev.accelerationIncludingGravity.y !== null && ev.accelerationIncludingGravity.z !== null) {\n        pipeline.motionAccelerometerSubmit(timeStamp, ev.accelerationIncludingGravity.x * profile_1.profile.deviceMotionMutliplier, ev.accelerationIncludingGravity.y * profile_1.profile.deviceMotionMutliplier, ev.accelerationIncludingGravity.z * profile_1.profile.deviceMotionMutliplier);\n      }\n\n      if (ev.rotationRate !== null && ev.rotationRate.alpha !== null && ev.rotationRate.beta !== null && ev.rotationRate.gamma !== null && !this._hasStartedOrientation) {\n        ev.timeStamp;\n        pipeline.motionRotationRateSubmit(timeStamp, ev.rotationRate.alpha * Math.PI / -180.0, ev.rotationRate.beta * Math.PI / -180.0, ev.rotationRate.gamma * Math.PI / -180.0);\n      } else if (!this._hasStartedOrientation) {\n        this._startDeviceOrientation();\n      }\n    };\n  }\n\n  static create(p, deviceId) {\n    let ret = latest++;\n    byId.set(ret, new CameraSource(ret, p, deviceId));\n    loglevel_1.zcout(\"camera_source_t initialized\");\n    return ret;\n  }\n\n  static get(m) {\n    return byId.get(m);\n  }\n\n  destroy() {\n    byId.delete(this._impl);\n    super.destroy();\n  }\n\n  _stop() {\n    if (!this._currentStream) return;\n\n    let tracks = this._currentStream.getTracks();\n\n    tracks.forEach(t => t.stop());\n    this._currentStream = null;\n  }\n\n  pause() {\n    super.pause();\n\n    this._stopDeviceMotion();\n\n    this._syncCamera();\n  }\n\n  start() {\n    super.start();\n\n    this._startDeviceMotion();\n\n    this._syncCamera();\n  }\n\n  _getConstraints() {\n    return __awaiter(this, void 0, void 0, function* () {\n      let deviceId;\n      let facingMode;\n\n      if (this._deviceId !== CameraSource.DEFAULT_DEVICE_ID && this._deviceId !== CameraSource.USER_DEFAULT_DEVICE_ID) {\n        // Custom device\n        deviceId = this._deviceId;\n      } else {\n        facingMode = this._deviceId === CameraSource.DEFAULT_DEVICE_ID ? \"environment\" : \"user\";\n      }\n\n      let constraints = {\n        audio: false,\n        video: {\n          facingMode: facingMode,\n          width: profile_1.profile.videoWidth,\n          height: profile_1.profile.videoHeight,\n          frameRate: profile_1.profile.requestHighFrameRate ? 60 : undefined,\n          deviceId: deviceId\n        }\n      };\n      if (deviceId) return constraints;\n      if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) return constraints;\n      let devices = yield navigator.mediaDevices.enumerateDevices();\n      let hasHadCapabilities = false;\n      devices = devices.filter(val => {\n        // Remove non-video devices\n        if (val.kind !== \"videoinput\") return false; // If the media info object contains capabilities, use it to filter to the correct facing cameras\n\n        if (val.getCapabilities) {\n          hasHadCapabilities = true;\n          let capabilities = val.getCapabilities();\n          if (capabilities && capabilities.facingMode && capabilities.facingMode.indexOf(facingMode === \"user\" ? \"user\" : \"environment\") < 0) return false;\n        }\n\n        return true;\n      }); // If none of the devices had capability info, or we have no devices left, fall back to the standard constraints\n\n      if (!hasHadCapabilities || devices.length === 0) {\n        return constraints;\n      }\n\n      if (typeof constraints.video === \"object\") {\n        loglevel_1.zcout(\"choosing device ID\", devices[devices.length - 1].deviceId);\n        constraints.video.deviceId = devices[devices.length - 1].deviceId;\n      }\n\n      return constraints;\n    });\n  }\n\n  getFrame(allowRead) {\n    this._cameraToScreenRotation = cameramodel_1.cameraRotationForScreenOrientation(false);\n    return super.getFrame(allowRead);\n  }\n\n  _getUserMedia() {\n    return __awaiter(this, void 0, void 0, function* () {\n      let constraints = yield this._getConstraints();\n      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) return yield navigator.mediaDevices.getUserMedia(constraints);\n      return yield new Promise((resolve, reject) => {\n        navigator.getUserMedia(constraints, resolve, reject);\n      });\n    });\n  }\n\n  _syncCamera() {\n    return __awaiter(this, void 0, void 0, function* () {\n      if (this._currentStream && this._isPaused) {\n        this._stop();\n\n        return;\n      }\n\n      if (this._currentStream && this._activeDeviceId !== this._deviceId) this._stop();\n\n      if (!this._isPaused) {\n        this._activeDeviceId = this._deviceId;\n        this._currentStream = yield this._getUserMedia();\n\n        if (this._isPaused) {\n          yield this._syncCamera();\n          return;\n        }\n\n        this._isUserFacing = false;\n\n        if (this._currentStream) {\n          let videoTracks = this._currentStream.getVideoTracks();\n\n          if (videoTracks.length > 0) {\n            this._isUserFacing = videoTracks[0].getSettings().facingMode === \"user\";\n          }\n        }\n\n        if (!(this._video instanceof HTMLVideoElement)) return;\n        this._video.src = \"\";\n        this._video.loop = false;\n        this._video.muted = true;\n        this._video.srcObject = this._currentStream;\n\n        this._video.play();\n      }\n    });\n  }\n\n  _startDeviceOrientation() {\n    if (this._hasStartedOrientation) return;\n    this._hasStartedOrientation = true;\n    window.addEventListener(\"deviceorientation\", ev => {\n      let pipeline = pipeline_1.Pipeline.get(this._pipeline);\n      if (!pipeline) return;\n      let timeStamp = ev.timeStamp !== undefined && ev.timeStamp !== null ? ev.timeStamp : performance.now();\n      if (ev.alpha === null || ev.beta === null || ev.gamma === null) return;\n      pipeline.motionAttitudeSubmit(timeStamp, ev.alpha, ev.beta, ev.gamma);\n    });\n  }\n\n  _startDeviceMotion() {\n    window.addEventListener(\"devicemotion\", this._deviceMotionListener, false);\n  }\n\n  _stopDeviceMotion() {\n    window.removeEventListener(\"devicemotion\", this._deviceMotionListener);\n  }\n\n}\n\nexports.CameraSource = CameraSource;\nCameraSource.USER_DEFAULT_DEVICE_ID = \"Simulated User Default Device ID: a908df7f-5661-4d20-b227-a1c15d2fdb4b\";\nCameraSource.DEFAULT_DEVICE_ID = \"Simulated Default Device ID: a908df7f-5661-4d20-b227-a1c15d2fdb4b\";","map":{"version":3,"sources":["/Users/StanleyWalker/Desktop/react-three-example-face-tracking-helmet-1/node_modules/@zappar/zappar-cv/lib/camera-source.js"],"names":["__awaiter","thisArg","_arguments","P","generator","adopt","value","resolve","Promise","reject","fulfilled","step","next","e","rejected","result","done","then","apply","Object","defineProperty","exports","CameraSource","html_element_source_1","require","profile_1","pipeline_1","cameramodel_1","loglevel_1","latest","byId","Map","_videoSingleton","document","createElement","setAttribute","profile","videoElementInDOM","style","width","height","body","appendChild","HTMLElementSource","constructor","_impl","pipeline","_deviceId","_currentStream","_activeDeviceId","_hasStartedOrientation","_deviceMotionListener","ev","Pipeline","get","_pipeline","timeStamp","undefined","performance","now","accelerationIncludingGravity","x","y","z","motionAccelerometerSubmit","deviceMotionMutliplier","rotationRate","alpha","beta","gamma","motionRotationRateSubmit","Math","PI","_startDeviceOrientation","create","p","deviceId","ret","set","zcout","m","destroy","delete","_stop","tracks","getTracks","forEach","t","stop","pause","_stopDeviceMotion","_syncCamera","start","_startDeviceMotion","_getConstraints","facingMode","DEFAULT_DEVICE_ID","USER_DEFAULT_DEVICE_ID","constraints","audio","video","videoWidth","videoHeight","frameRate","requestHighFrameRate","navigator","mediaDevices","enumerateDevices","devices","hasHadCapabilities","filter","val","kind","getCapabilities","capabilities","indexOf","length","getFrame","allowRead","_cameraToScreenRotation","cameraRotationForScreenOrientation","_getUserMedia","getUserMedia","_isPaused","_isUserFacing","videoTracks","getVideoTracks","getSettings","_video","HTMLVideoElement","src","loop","muted","srcObject","play","window","addEventListener","motionAttitudeSubmit","removeEventListener"],"mappings":"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","sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.CameraSource = void 0;\nconst html_element_source_1 = require(\"./html-element-source\");\nconst profile_1 = require(\"./profile\");\nconst pipeline_1 = require(\"./pipeline\");\nconst cameramodel_1 = require(\"./cameramodel\");\nconst loglevel_1 = require(\"./loglevel\");\nlet latest = 1;\nlet byId = new Map();\nlet _videoSingleton = document.createElement(\"video\");\n_videoSingleton.setAttribute('playsinline', '');\n_videoSingleton.setAttribute('webkit-playsinline', '');\nif (profile_1.profile.videoElementInDOM) {\n    _videoSingleton.style.width = \"0px\";\n    _videoSingleton.style.height = \"0px\";\n    document.body.appendChild(_videoSingleton);\n}\nclass CameraSource extends html_element_source_1.HTMLElementSource {\n    constructor(_impl, pipeline, _deviceId) {\n        super(_videoSingleton, pipeline);\n        this._impl = _impl;\n        this._deviceId = _deviceId;\n        this._currentStream = null;\n        this._activeDeviceId = null;\n        this._hasStartedOrientation = false;\n        this._deviceMotionListener = (ev) => {\n            let pipeline = pipeline_1.Pipeline.get(this._pipeline);\n            if (!pipeline)\n                return;\n            let timeStamp = (ev.timeStamp !== undefined && ev.timeStamp !== null) ? ev.timeStamp : performance.now();\n            if (ev.accelerationIncludingGravity !== null &&\n                ev.accelerationIncludingGravity.x !== null &&\n                ev.accelerationIncludingGravity.y !== null &&\n                ev.accelerationIncludingGravity.z !== null) {\n                pipeline.motionAccelerometerSubmit(timeStamp, ev.accelerationIncludingGravity.x * profile_1.profile.deviceMotionMutliplier, ev.accelerationIncludingGravity.y * profile_1.profile.deviceMotionMutliplier, ev.accelerationIncludingGravity.z * profile_1.profile.deviceMotionMutliplier);\n            }\n            if (ev.rotationRate !== null &&\n                ev.rotationRate.alpha !== null &&\n                ev.rotationRate.beta !== null &&\n                ev.rotationRate.gamma !== null && !this._hasStartedOrientation) {\n                ev.timeStamp;\n                pipeline.motionRotationRateSubmit(timeStamp, ev.rotationRate.alpha * Math.PI / -180.0, ev.rotationRate.beta * Math.PI / -180.0, ev.rotationRate.gamma * Math.PI / -180.0);\n            }\n            else if (!this._hasStartedOrientation) {\n                this._startDeviceOrientation();\n            }\n        };\n    }\n    static create(p, deviceId) {\n        let ret = (latest++);\n        byId.set(ret, new CameraSource(ret, p, deviceId));\n        loglevel_1.zcout(\"camera_source_t initialized\");\n        return ret;\n    }\n    static get(m) {\n        return byId.get(m);\n    }\n    destroy() {\n        byId.delete(this._impl);\n        super.destroy();\n    }\n    _stop() {\n        if (!this._currentStream)\n            return;\n        let tracks = this._currentStream.getTracks();\n        tracks.forEach(t => t.stop());\n        this._currentStream = null;\n    }\n    pause() {\n        super.pause();\n        this._stopDeviceMotion();\n        this._syncCamera();\n    }\n    start() {\n        super.start();\n        this._startDeviceMotion();\n        this._syncCamera();\n    }\n    _getConstraints() {\n        return __awaiter(this, void 0, void 0, function* () {\n            let deviceId;\n            let facingMode;\n            if (this._deviceId !== CameraSource.DEFAULT_DEVICE_ID &&\n                this._deviceId !== CameraSource.USER_DEFAULT_DEVICE_ID) {\n                // Custom device\n                deviceId = this._deviceId;\n            }\n            else {\n                facingMode = (this._deviceId === CameraSource.DEFAULT_DEVICE_ID) ? \"environment\" : \"user\";\n            }\n            let constraints = {\n                audio: false,\n                video: {\n                    facingMode: facingMode,\n                    width: profile_1.profile.videoWidth,\n                    height: profile_1.profile.videoHeight,\n                    frameRate: profile_1.profile.requestHighFrameRate ? 60 : undefined,\n                    deviceId: deviceId\n                }\n            };\n            if (deviceId)\n                return constraints;\n            if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices)\n                return constraints;\n            let devices = yield navigator.mediaDevices.enumerateDevices();\n            let hasHadCapabilities = false;\n            devices = devices.filter(val => {\n                // Remove non-video devices\n                if (val.kind !== \"videoinput\")\n                    return false;\n                // If the media info object contains capabilities, use it to filter to the correct facing cameras\n                if (val.getCapabilities) {\n                    hasHadCapabilities = true;\n                    let capabilities = val.getCapabilities();\n                    if (capabilities && capabilities.facingMode && capabilities.facingMode.indexOf(facingMode === \"user\" ? \"user\" : \"environment\") < 0)\n                        return false;\n                }\n                return true;\n            });\n            // If none of the devices had capability info, or we have no devices left, fall back to the standard constraints\n            if (!hasHadCapabilities || devices.length === 0) {\n                return constraints;\n            }\n            if (typeof constraints.video === \"object\") {\n                loglevel_1.zcout(\"choosing device ID\", devices[devices.length - 1].deviceId);\n                constraints.video.deviceId = devices[devices.length - 1].deviceId;\n            }\n            return constraints;\n        });\n    }\n    getFrame(allowRead) {\n        this._cameraToScreenRotation = cameramodel_1.cameraRotationForScreenOrientation(false);\n        return super.getFrame(allowRead);\n    }\n    _getUserMedia() {\n        return __awaiter(this, void 0, void 0, function* () {\n            let constraints = yield this._getConstraints();\n            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia)\n                return yield navigator.mediaDevices.getUserMedia(constraints);\n            return yield new Promise((resolve, reject) => {\n                navigator.getUserMedia(constraints, resolve, reject);\n            });\n        });\n    }\n    _syncCamera() {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (this._currentStream && this._isPaused) {\n                this._stop();\n                return;\n            }\n            if (this._currentStream && this._activeDeviceId !== this._deviceId)\n                this._stop();\n            if (!this._isPaused) {\n                this._activeDeviceId = this._deviceId;\n                this._currentStream = yield this._getUserMedia();\n                if (this._isPaused) {\n                    yield this._syncCamera();\n                    return;\n                }\n                this._isUserFacing = false;\n                if (this._currentStream) {\n                    let videoTracks = this._currentStream.getVideoTracks();\n                    if (videoTracks.length > 0) {\n                        this._isUserFacing = videoTracks[0].getSettings().facingMode === \"user\";\n                    }\n                }\n                if (!(this._video instanceof HTMLVideoElement))\n                    return;\n                this._video.src = \"\";\n                this._video.loop = false;\n                this._video.muted = true;\n                this._video.srcObject = this._currentStream;\n                this._video.play();\n            }\n        });\n    }\n    _startDeviceOrientation() {\n        if (this._hasStartedOrientation)\n            return;\n        this._hasStartedOrientation = true;\n        window.addEventListener(\"deviceorientation\", (ev) => {\n            let pipeline = pipeline_1.Pipeline.get(this._pipeline);\n            if (!pipeline)\n                return;\n            let timeStamp = (ev.timeStamp !== undefined && ev.timeStamp !== null) ? ev.timeStamp : performance.now();\n            if (ev.alpha === null || ev.beta === null || ev.gamma === null)\n                return;\n            pipeline.motionAttitudeSubmit(timeStamp, ev.alpha, ev.beta, ev.gamma);\n        });\n    }\n    _startDeviceMotion() {\n        window.addEventListener(\"devicemotion\", this._deviceMotionListener, false);\n    }\n    _stopDeviceMotion() {\n        window.removeEventListener(\"devicemotion\", this._deviceMotionListener);\n    }\n}\nexports.CameraSource = CameraSource;\nCameraSource.USER_DEFAULT_DEVICE_ID = \"Simulated User Default Device ID: a908df7f-5661-4d20-b227-a1c15d2fdb4b\";\nCameraSource.DEFAULT_DEVICE_ID = \"Simulated Default Device ID: a908df7f-5661-4d20-b227-a1c15d2fdb4b\";\n"]},"metadata":{},"sourceType":"script"}